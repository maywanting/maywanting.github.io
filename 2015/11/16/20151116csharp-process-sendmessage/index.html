<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>用消息传输实现进程间通信 | Welcome to May's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Welcome to May's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick=""><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>用消息传输实现进程间通信</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2015-11-16</div><div class="post-categories"><a class="post-category-link" href="/categories/Study/">Study</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/C/">C#</a></div></div></div><article><div class="container post"><p>前段时间操作系统的实验课要求我们实现windows下进程间的通信，正好趁这个温习以下C#的写法，啊哈哈~····</p>
<blockquote>
<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2></blockquote>
<p>简单的说就是程序p1负责获取用户输入的要求，是打开程序并输入程序名或是关闭程序并输入程序名。然后p1将获取的数据通过进程间通信传给进程p2，p2负责程序的调度。</p>
<blockquote>
<h2 id="p1进程"><a href="#p1进程" class="headerlink" title="p1进程"></a>p1进程</h2></blockquote>
<p>p1要干的事情就是收集用户输入的信息，然后在发送给p2，这有点像web里面的客户端也就是前台哈。</p>
<h3 id="1、收集前台信息包装"><a href="#1、收集前台信息包装" class="headerlink" title="1、收集前台信息包装"></a>1、收集前台信息包装</h3><p>窗体设计如下，就不贴代码了，拖拖控件还是非常简单的<br><img src="/image/20151115_2.png" alt="p1"></p>
<p>这里获取数据和asp.net一样，为了方便传输，将打开或关闭用数字表示，然后程序名string表示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> flag = (textBox1.Text.ToString().Equals(<span class="string">"open"</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">String name = textBox2.Text.ToString();</span><br></pre></td></tr></table></figure>
<p>进程间通信有三种方式，一种是共享内存，还有消息传输，还有剪贴板，这里面采用消息传输，也就是说用sendMessage这个函数，首先得调用动态链接库里的函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//要传输数据，必须得用这样的结构体！</span></span><br><span class="line"><span class="keyword">public</span> struct My_lParam &#123;</span><br><span class="line">    <span class="keyword">public</span> IntPtr dwData;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> cbData; <span class="comment">//open or close</span></span><br><span class="line">    [MarshalAs(UnmanagedType.LPStr)]</span><br><span class="line">    <span class="keyword">public</span> string lpData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[DllImport(<span class="string">"user32.dll"</span>, EntryPoint = <span class="string">"SendMessage"</span>)]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> extern <span class="keyword">int</span> <span class="title">SendMessage</span><span class="params">(IntPtr wnd, <span class="keyword">int</span> msg, <span class="keyword">int</span> wP, ref My_lParam lP)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="2、发送数据"><a href="#2、发送数据" class="headerlink" title="2、发送数据"></a>2、发送数据</h3><p>然后就是传输数据，这里是通过button点击事件触发传送，如何找到p2进程则是通过获取当前所有进程的信息，然后一一排查它的名字然后找到p2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button1_Click</span><span class="params">(object sender, EventArgs e)</span> </span>&#123;</span><br><span class="line">    Process[] pros = Process.GetProcesses(); <span class="comment">//获取本机所有进程</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pros.Length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pros[i].ProcessName == <span class="string">"p2"</span>) <span class="comment">//名称为ProcessCommunication的进程 &#123;</span></span><br><span class="line">            <span class="comment">//sendmessage</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3、p1完整代码"><a href="#3、p1完整代码" class="headerlink" title="3、p1完整代码"></a>3、p1完整代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> struct My_lParam &#123;</span><br><span class="line">    <span class="keyword">public</span> IntPtr dwData;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> cbData; <span class="comment">//open or close</span></span><br><span class="line">    [MarshalAs(UnmanagedType.LPStr)]</span><br><span class="line">    <span class="keyword">public</span> string lpData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[DllImport(<span class="string">"user32.dll"</span>, EntryPoint = <span class="string">"SendMessage"</span>)]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> extern <span class="keyword">int</span> <span class="title">SendMessage</span><span class="params">(IntPtr wnd, <span class="keyword">int</span> msg, <span class="keyword">int</span> wP, ref My_lParam lP)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button1_Click</span><span class="params">(object sender, EventArgs e)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//数据包装</span></span><br><span class="line">    My_lParam lp = <span class="keyword">new</span> My_lParam();</span><br><span class="line">    <span class="keyword">int</span> flag = (textBox1.Text.ToString().Equals(<span class="string">"open"</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    lp.dwData = (IntPtr)<span class="number">100</span>;</span><br><span class="line">    lp.lpData = textBox2.Text.ToString();</span><br><span class="line">    <span class="keyword">byte</span>[] sarr = System.Text.Encoding.UTF8.GetBytes(lp.lpData);</span><br><span class="line">    <span class="keyword">int</span> len = sarr.Length;</span><br><span class="line">    lp.cbData = len + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    Process[] pros = Process.GetProcesses(); <span class="comment">//获取本机所有进程</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pros.Length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pros[i].ProcessName == <span class="string">"p2"</span>) <span class="comment">//名称为ProcessCommunication的进程 &#123;</span></span><br><span class="line">            IntPtr hWnd = pros[i].MainWindowHandle; <span class="comment">//获取ProcessCommunication.exe主窗口句柄</span></span><br><span class="line">            SendMessage(hWnd, <span class="number">0x4A</span>, flag, ref lp); <span class="comment">//点击该按钮，以文本框数据为参数，向Form1发送WM_KEYDOWN消息</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意:</p>
<ul>
<li>sendMessage的第二个参数必须得是0x4A，因为0x4A才表示向另一个进程传输数据</li>
<li>因为用了0x4A，所以sendMessage的第四个参数必须得是My_lParam这个结构体的样子</li>
</ul>
<p>详细看<a href="https://msdn.microsoft.com/en-us/library/ms649011.aspx" target="_blank" rel="noopener">官方文档</a></p>
<blockquote>
<h2 id="p2进程"><a href="#p2进程" class="headerlink" title="p2进程"></a>p2进程</h2></blockquote>
<p>p2进程就是接收来自p1发送的数据，然后根据发送的指令，如果收到第三个参数是1，则创建一个进程，否则结束该进程 <br></p>
<p>p2界面</p>
<p><img src="/image/20151115_1.png" alt="p2"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> struct My_lParam &#123;</span><br><span class="line">    <span class="keyword">public</span> IntPtr dwData;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> cbData; <span class="comment">//open or close</span></span><br><span class="line">    [MarshalAs(UnmanagedType.LPStr)]</span><br><span class="line">    <span class="keyword">public</span> string lpData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//不断捕捉信号</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> override <span class="keyword">void</span> <span class="title">DefWndProc</span><span class="params">(ref Message m)</span> </span>&#123;</span><br><span class="line">    base.DefWndProc(ref m);</span><br><span class="line">    <span class="keyword">if</span> (m.Msg == <span class="number">0x4A</span>) &#123;</span><br><span class="line">        My_lParam mystr = <span class="keyword">new</span> My_lParam();</span><br><span class="line">        Type mytype = mystr.GetType();</span><br><span class="line">        mystr = (My_lParam)m.GetLParam(mytype);</span><br><span class="line">        string threadName = mystr.lpData;  <span class="comment">//获取数据</span></span><br><span class="line">        <span class="keyword">int</span> flag = m.WParam.ToInt32();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">            Process p = <span class="keyword">new</span> Process();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//进程默认是放在同一根目录下。</span></span><br><span class="line">            p.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, threadName + <span class="string">".exe"</span>);  </span><br><span class="line">            p.StartInfo.Arguments = threadName + <span class="string">".exe"</span>;</span><br><span class="line">            p.StartInfo.UseShellExecute = <span class="keyword">true</span>;</span><br><span class="line">            p.Start();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Process[] p = Process.GetProcessesByName(threadName);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; p.Length; i++) &#123;</span><br><span class="line">                p[i].Kill();</span><br><span class="line">                p[i].Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h2 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h2></blockquote>
<p>然后两个进程同时运行一下,就能实现进程间的通信了，而且还是实时的哦～<br><br>代码写成这样基本就可以交差了，及格妥妥的！</p>
<p>The End~</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'maywanting';
var disqus_identifier = '2015/11/16/20151116csharp-process-sendmessage/';
var disqus_title = '用消息传输实现进程间通信';
var disqus_url = 'http://maywanting.wang/2015/11/16/20151116csharp-process-sendmessage/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:may@maywanting.wang" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="http://weibo.com/[object Object]" target="_blank"><i class="fa fa-weibo"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2019 <a href="/" rel="nofollow">may</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>