<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>用Nginx 服务器配置多版本的PHP | Welcome to May's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Welcome to May's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick=""><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>用Nginx 服务器配置多版本的PHP</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-09-27</div><div class="post-categories"><a class="post-category-link" href="/categories/Experience/">Experience</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a>/<a class="post-tag-link" href="/tags/PHP/">PHP</a>/<a class="post-tag-link" href="/tags/php-fpm/">php-fpm</a></div></div></div><article><div class="container post"><p>本文配置的是 centos 系统上，用 nginx 服务器同时支持 php7 与 php5。</p>
<blockquote>
<h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2></blockquote>
<p>8 月份的时候我写了一篇吐槽的博客 <a href="http://maywanting.wang/2016/08/20/20160820project-deploy/">记一次项目的开发到部署</a>， 这里面我说过自己配置过 nginx 对于双版本 php 的支持，所以说这篇文章我本来早就想写了，一直没时间……现在补上。</p>
<blockquote>
<h2 id="必要的安装"><a href="#必要的安装" class="headerlink" title="必要的安装"></a>必要的安装</h2></blockquote>
<p>自己配的时候，原本系统已经装好了 php5.6 和 nginx，只不过服务都没跑起来，所以我只要装 php7 就行了。那么 php7 我是怎么装的呢，恩……采用最原始的下载 C 代码编译安装…………具体的安装过程下一篇博客记录吧。</p>
<p>这里吐槽一下 ubuntu16.04，我用 apt 包管理器装 php 的时候没注意，等我装完一看装的 php7……瞬间惊呆了。</p>
<blockquote>
<h2 id="nginx-与-php-之间的通信"><a href="#nginx-与-php-之间的通信" class="headerlink" title="nginx 与 php 之间的通信"></a>nginx 与 php 之间的通信</h2></blockquote>
<p>在写怎么配置之前，我觉得有必要说清楚 ngnix 与 php 之间是怎么通信的。让我们一步一步来哈～</p>
<p>首先一个请求过来，例如 <code>http://php7.host/index.php</code>，然后 nginx 就根据域名找对应的 server 块，这里域名是 <code>php7.host</code>，所以 nginx 会找 server 中设置 <code>server_name php7.host</code>，然后解析里面 location 规则。</p>
<p>但凡是支持运行 php 的，必定会有对于请求结尾是 <code>.php</code> 的处理，这种处理的 location，基本都是以下的配置规则，或者是它的精细化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name php7.host;</span><br><span class="line"></span><br><span class="line">    …………</span><br><span class="line"></span><br><span class="line">    location ~ \.php &#123;</span><br><span class="line">        //对于 php 请求的处理</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上匹配规则就说明最后带 <code>.php</code> 的执行以下操作。</p>
<p>实际上，nginx 本身是不支持调用解析 php，所以必须通过一个通用的接口来调起守护进程进行 php 解析，这个就是 FastCGI。所谓 FastCGI，就是在 Http server（例如 nginx）和动态脚本语言（例如 php）中间通信的的接口。它负责启用一个或多个叫做 FastCGI 进程管理器的守护进程来解析 php，而 php-fpm 就是 FastCGI 进程管理器中处理 php 的一种，也是处理 php 最常用的一种，至少目前的 php 都默认把 php-fpm 都一起编译进了内核。</p>
<p>所以 nginx 在处理动态脚本的时候其实就是一个反向代理服务器，自身处理一些静态请求（例如请求文件），然后将所有需要脚本语言解析的动态请求（例如 php，python）全部交给 FastCGI 接口。</p>
<p>FastCGI 进程管理器与 nginx 通信则是通过 socket，文件 socket 和 ip socket 都可以，所以一个 FastCGI 进程管理器就会监听一个 socket 文件或者一个端口，且不能重复占用。</p>
<p>根据以上的知识，其实做到支持两个版本的 php 就是将两个请求的 url 单独分开处理，交给两个不同的 php-fpm 进程进行解析，而且分别使用不同的 socket 通信。</p>
<blockquote>
<h2 id="配置-php5"><a href="#配置-php5" class="headerlink" title="配置 php5"></a>配置 php5</h2></blockquote>
<p>这里的配置和普通意义上配置 php 环境类似。</p>
<h3 id="1、nginx-配置"><a href="#1、nginx-配置" class="headerlink" title="1、nginx 配置"></a>1、nginx 配置</h3><p>首先说一下，为了以示区别，php5 不用默认的 <code>localhost</code> 访问，采用域名 <code>php5.host</code>，然后本地设置 host 指向 <code>127.0.0.1</code>，然后单独拉个 server 块，FastCGI 进程管理器指定监听 socket 文件。</p>
<p>以下为具体的 server 块配置，具体在 nginx.conf 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">upstream phpfile&#123;</span><br><span class="line">    server unix:/run/php/phpfpm.socket; //一般安装 php 的时候就会有默认的 phpfpm.socket 文件，指向这个文件就行了。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name php5.host;</span><br><span class="line"></span><br><span class="line">    root /data/www/html/php5/;  //解析地址的根目录</span><br><span class="line"></span><br><span class="line">    access_log /var/<span class="built_in">log</span>/nginx/php5_access.log; //访问日志，这个很重要，往往查日志需要这个。</span><br><span class="line">    error_log /var/<span class="built_in">log</span>/nginx/php5_error.log; //错误日志，这个也很重要，排查 bug 往往需要查看这个</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html index.php; //当只有一个 url 过来，指明默认访问的文件。</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php &#123; //所有后缀名为 .php 的都执行以下操作</span><br><span class="line">        fastcgi_pass phpfile; //全部交给 /run/php/phpfpm.socket。</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启 nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -t;</span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload;</span><br></pre></td></tr></table></figure>
<h3 id="2、php-fpm-配置"><a href="#2、php-fpm-配置" class="headerlink" title="2、php-fpm 配置"></a>2、php-fpm 配置</h3><p>nginx 配置之后，然后配置 php-fpm.conf</p>
<p>主要就是让 php-fpm 从 <code>/run/php/phpfpm.socket</code> 中获取数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">pid = /run/php/php-fpm.pid</span><br><span class="line">error_log = /var/<span class="built_in">log</span>/php/php5-fpm.log</span><br><span class="line">log_level = notice</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line">listen = /run/php/phpfpm.socket //通信数据获取来源</span><br><span class="line">listen.backlog = -1</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">listen.owner = www-data</span><br><span class="line">listen.group = www-data</span><br><span class="line">listen.mode = 0666</span><br><span class="line">user = www-data</span><br><span class="line">group = www-data</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 1024</span><br><span class="line">pm.start_servers = 50</span><br><span class="line">pm.min_spare_servers = 50</span><br><span class="line">pm.max_spare_servers = 1024</span><br><span class="line">request_terminate_timeout = 100</span><br><span class="line">request_slowlog_timeout = 0</span><br><span class="line">slowlog = /var/<span class="built_in">log</span>/php/php5-slow.log</span><br></pre></td></tr></table></figure>
<p>然后启动 php-fpm 就可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/php/sbin/php-fpm --fpm-config /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf</span><br></pre></td></tr></table></figure>
<p>贴个图展示下成果</p>
<p><img src="/image/20160927_2.jpg" alt="php5 配置成功"></p>
<blockquote>
<h2 id="配置-php7"><a href="#配置-php7" class="headerlink" title="配置 php7"></a>配置 php7</h2></blockquote>
<p>由于 php7 是后来我编译安装的，原本 php5.6 装在 <code>/usr/local/php/</code> 下，所以 php7 为了防止名字冲突（其实已经很多地方已经冲突了，造成我在部署 php7 的时候踩了一个坑），php7 就装在 <code>/usr/local/php7/</code> 下</p>
<h3 id="1、nginx-配置-1"><a href="#1、nginx-配置-1" class="headerlink" title="1、nginx 配置"></a>1、nginx 配置</h3><p>和 php5 一样，为了以示区别，php7 用域名 <code>php7.host</code> 访问，本地设置 host 指向 <code>127.0.0.1</code>，然后也是单独拉出来一个 server 块。这里指定 FastCHI 进程管理器监听一个端口，就 8022 吧。</p>
<p>以下为具体的 server 块配置，具体在 nginx.conf 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">upstream phpport&#123;</span><br><span class="line">    server 127.0.0.1:8002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name php7.host;</span><br><span class="line"></span><br><span class="line">    root /data/www/html/php7/;  //解析地址的根目录</span><br><span class="line"></span><br><span class="line">    access_log /var/<span class="built_in">log</span>/nginx/php7_access.log; //访问日志，这个很重要，往往查日志需要这个。</span><br><span class="line">    error_log /var/<span class="built_in">log</span>/nginx/php7_error.log; //错误日志，这个也很重要，排查 bug 往往需要查看这个</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html index.php; //当只有一个 url 过来，指明默认访问的文件。</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php &#123; //所有后缀名为 .php 的都执行以下操作</span><br><span class="line">        fastcgi_pass phpport; //全部交给 127.0.0.1:8022 这个端口来。</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启 nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -t;</span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload;</span><br></pre></td></tr></table></figure>
<h3 id="2、php-fpm-配置-1"><a href="#2、php-fpm-配置-1" class="headerlink" title="2、php-fpm 配置"></a>2、php-fpm 配置</h3><p>nginx 配置之后，然后配置 php-fpm.conf</p>
<p>主要就是让 php-fpm 从 8022 端口中获取数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">pid = /run/php7/php-fpm.pid</span><br><span class="line">error_log = /var/<span class="built_in">log</span>/php7/php7-fpm.log</span><br><span class="line">log_level = notice</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line">listen = 127.0.0.1:8022 //通信数据获取来源</span><br><span class="line">listen.backlog = -1</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">listen.owner = www-data</span><br><span class="line">listen.group = www-data</span><br><span class="line">listen.mode = 0666</span><br><span class="line">user = www-data</span><br><span class="line">group = www-data</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 1024</span><br><span class="line">pm.start_servers = 50</span><br><span class="line">pm.min_spare_servers = 50</span><br><span class="line">pm.max_spare_servers = 1024</span><br><span class="line">request_terminate_timeout = 100</span><br><span class="line">request_slowlog_timeout = 0</span><br><span class="line">slowlog = /var/<span class="built_in">log</span>/php7/php7-slow.log</span><br></pre></td></tr></table></figure>
<p>然后启动 php-fpm 就可以了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/php7/sbin/php-fpm --fpm-config /usr/<span class="built_in">local</span>/php7/etc/php-fpm.conf</span><br></pre></td></tr></table></figure>
<p>贴个图展示下成果</p>
<p><img src="/image/20160927_1.jpg" alt="php7 配置成功"></p>
<blockquote>
<h2 id="一些吐槽"><a href="#一些吐槽" class="headerlink" title="一些吐槽"></a>一些吐槽</h2></blockquote>
<p>之前一切都很顺利，在配置 php7 的时候就开始踩坑了。</p>
<p>在装完 php 的时候，php 会默认装一个全局的命令 <code>php-fpm</code>，然后这个 <code>php-fpm</code> 命令不用想也知道是事先安装的 php5.6 的，php7 的 <code>php-fpm</code> 命令则需要通过最原始的绝对路径来调用。不指明路径的话，那么还是 php5.6 的 php-fpm 换了个 php7 配置文件重新跑，而 php7 的服务压根没跑起来。</p>
<p>所以我在配置的时候就发生了诡异的现象：域名 <code>php5.host</code> 访问的好好的，启动 php7 的 php-fpm 之后，用 <code>php7.host</code> 访问显示的 php 版本还是 php5.6，而 <code>php5.host</code> 访问则 404 了。这报错曾让我一度怀疑起了人生……</p>
<p>其实用查看现在跑了哪些进程也可以看出来是否配置正确，因为如果两版本 php 服务都跑起来的话，是会看到两个一毛一样的 php-fpm，当然再加一个参数就可以看出来这两个 php-fpm 分别属于哪种 php 了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps anx | grep php</span><br></pre></td></tr></table></figure>
<p>所以说啊，没事别装两个版本的 php……一来一些全局命令如果不注意就会用错版本，二来一些扩展的维护也比较麻烦。</p>
<p>The End~</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2019 <a href="/" rel="nofollow">may</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>