<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>基于Laravel框架的后台权限设计 | Welcome to May's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Welcome to May's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick=""><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>基于Laravel框架的后台权限设计</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-03-05</div><div class="post-categories"><a class="post-category-link" href="/categories/Experience/">Experience</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/Laravel/">Laravel</a>/<a class="post-tag-link" href="/tags/PHP/">PHP</a></div></div></div><article><div class="container post"><p>以下只是我在毕设系统中设计的权限管理的一套方案，算是第一次造轮子写这个，不成熟的地方还请指教（0.0）</p>
<blockquote>
<h2 id="扯下权限控制"><a href="#扯下权限控制" class="headerlink" title="扯下权限控制"></a>扯下权限控制</h2></blockquote>
<p>按照我的经验来说，权限控制的方式大体有两种</p>
<ul>
<li>通过前台的隐藏来控制用户可以进行哪些操作</li>
<li>后台通过数据库中管理员分配的行为权限，查看该用户的角色和请求的行为是否合法</li>
</ul>
<p>说人话就是，通过前台和后台两种方式控制。</p>
<p>如果只是前台控制，只要稍微懂点网页的，只需知道发送的数据，简单点可以通过url打开本来无权限的页面，高级点自己伪造post请求。</p>
<p>如果只是后台控制，极端点，用户点的功能然后一直返回说自己没权限访问，用户体验非常不好。</p>
<p>所以说了这么多废话，就是想说现在只要是正常的管理系统，都会有结合以上两种进行控制，毕竟面向的用户鱼龙混杂，林子大了啥鸟都有。。。不过这好像也是废话</p>
<blockquote>
<h2 id="大体的设计方案"><a href="#大体的设计方案" class="headerlink" title="大体的设计方案"></a>大体的设计方案</h2></blockquote>
<p>现在我讨论的只是后台的控制。</p>
<ul>
<li>同学A：按照每个模块增删改查，然后其他特殊功能再加上。</li>
<li>我评价：控制粒度有点粗，不过这样的话前台对应好写，然而这样注定要写很多判断代码，作为写后台的我表示我很懒！！<br><br></li>
<li>我：我认为在mvc中，用户的每一个操作都对应与control层的一个函数，所以只要在调用control层的某个函数前看看用户有没有调用这个函数的权限就行。</li>
<li>我评价：只要写一个通用的判断函数就可以搞定，代码量少，然而控制的太细，管理员在分配权限的时候会有点痛苦，然而代码少我喜欢！</li>
</ul>
<p>由于后台是我负责的，所以理所当然的用我的方案，只是这样的话前台不好控制目前在考虑将按钮，链接什么的做成函数的形式,后台填写，这样的话前台也能控制。自己挖的坑，哭着跪着也要填完。。</p>
<blockquote>
<h2 id="详细设计"><a href="#详细设计" class="headerlink" title="详细设计"></a>详细设计</h2></blockquote>
<p>现在大体方案有了，就先设计数据库，关键是用户的权限如何设计存储。由于毕设系统的角色是固定的，就只有老师、学生、管理员。而且目前来看，系统中有些功能对于目前角色的关联性还是非常强的，所以暂时不存在角色间权限的继承什么的。</p>
<p>参考了大大们的意见，大致考虑了三套方案。</p>
<blockquote>
<p>以control中的一个类为记录的最小粒度，也就是一个control类就是一条记录，然后该类的方法权限以及角色的权限，则按json格式存储。然后当用户登录，就将他的所有权限写入到session中。</p>
</blockquote>
<p>由于每次调用函数只要查找session就行了，效率会在一定程度高点，但是由于存储在session，对于一些实时性的功能支持性不高。</p>
<p>举个栗子，老师说，12点正式开始抢选课，然后肯定有很多人在11点五十几分就登录系统，然后12点老师在权限里面开启了选题功能，然而那些先登录的人看到12点过了还是无法选课就一脸懵逼以为系统坏了，等他重新登录，选题都被抢光了，然后痛骂写这个系统的人= =。说实话我不想背锅也得背。</p>
<p>其实以上问题也很好解决，增加管理员可以不通过权限管理来开启功能，再添加一个时间控制的限定。不过这些功能我还没写呢，有了这功能，我估计我的权限管理会采取这个方案，目前还不适合。</p>
<p>以下为数据库表的结构。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------+------------------+--------+-------+-----------+----------------+</span></span><br><span class="line">| Field      | Type             | Null   | Key   |   Default | Extra          |</span><br><span class="line">|<span class="comment">------------+------------------+--------+-------+-----------+----------------|</span></span><br><span class="line">| id         | int(10) unsigned | NO     | PRI   |    &lt;null&gt; | auto_increment |</span><br><span class="line">| model      | varchar(255)     | NO     |       |    &lt;null&gt; |                |</span><br><span class="line">| name       | varchar(255)     | NO     |       |    &lt;null&gt; |                |</span><br><span class="line">| authority  | text             | NO     |       |    &lt;null&gt; |                |</span><br><span class="line">| created_at | timestamp        | YES    |       |    &lt;null&gt; |                |</span><br><span class="line">| updated_at | timestamp        | YES    |       |    &lt;null&gt; |                |</span><br><span class="line">+<span class="comment">------------+------------------+--------+-------+-----------+----------------+</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>以control中的类的每个函数为记录的最小粒度，也就是control中的一个函数一条记录（不包括魔术方法），权限则是按照约定好的角色顺序弄成01字符串存储。而且每次调用函数都会查找数据库。</p>
</blockquote>
<p>这是我目前在用的方案，方便查找，但是也就这个系统适用，当多个角色之间有继承关系或是新增角色的话就不适用。目前来讲还是可行的。</p>
<p>以下为数据库的表的结构。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------+------------------+--------+-------+-----------+----------------+</span></span><br><span class="line">| Field      | Type             | Null   | Key   |   Default | Extra          |</span><br><span class="line">|<span class="comment">------------+------------------+--------+-------+-----------+----------------|</span></span><br><span class="line">| id         | int(10) unsigned | NO     | PRI   |    &lt;null&gt; | auto_increment |</span><br><span class="line">| model      | varchar(255)     | NO     |       |    &lt;null&gt; |                |</span><br><span class="line">| method     | varchar(255)     | NO     |       |    &lt;null&gt; |                |</span><br><span class="line">| name       | varchar(255)     | NO     |       |    &lt;null&gt; |                |</span><br><span class="line">| authority  | varchar(100)     | NO     |       |       000 |                |</span><br><span class="line">| created_at | timestamp        | YES    |       |    &lt;null&gt; |                |</span><br><span class="line">| updated_at | timestamp        | YES    |       |    &lt;null&gt; |                |</span><br><span class="line">+<span class="comment">------------+------------------+--------+-------+-----------+----------------+</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>按角色的权限为记录的最小粒度，说白了就是上一种方案中，将01串拉开而已。</p>
</blockquote>
<p>这方案刚想起就被我弊了，可以说这个方案很适合角色不固定的情况，然而这个系统角色固定，所以采用这种方案势必会产生很大的数据冗余。</p>
<blockquote>
<h2 id="关于laravel中的middleware"><a href="#关于laravel中的middleware" class="headerlink" title="关于laravel中的middleware"></a>关于laravel中的middleware</h2></blockquote>
<p>上面说了一堆设计的思路，下面就开始着手写代码了。具体在哪里控制，这又是一个问题。其实，在哪加的思路很简单，就是在route查找之后，进入函数之前。</p>
<p>在这之前咱们扯扯middleware，其实我觉得middleware就是为了权限而设计的，以下为刚初始化的middleware的类。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Guard</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorityMiddleware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而我发现一个事实，$request 中只有请求的url，并没有通过route查找传来的类名和方法名= =。要获得这些还得看框架源码，在一处地方开个默认参数传方法和模块进来（没试过）。</p>
<p>虽然同学B说直接按照url来控制，然而我是拒绝的。首先不说url与control的函数之间的关系不是一一映射，有的url只是单纯的返回一个静态页面，而且url里面有的含有参数，要正则匹配嘛。。。我是拒绝的！</p>
<p>通过以上思考，基本确定，我是要改框架的。感觉这个举动有点冒险啊，毕竟一个改不好，系统就容易炸=。=</p>
<blockquote>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2></blockquote>
<p>上面废话了这么多，开始上代码吧。</p>
<p>在<code>vender/laravel/framework/src/Illuminate/Routing/Controller.php</code>里面有一个函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Execute an action on the controller.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $method</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array   $parameters</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Symfony\Component\HttpFoundation\Response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, $method], $parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没错，就是这个函数执行controller里面的函数，所以只要在这之前加个权限判断就行了。</p>
<p>改后代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;getMethodAuthority($method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'noAuthority'</span>); <span class="comment">//返回没有权限的页面</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, $method], $parameters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getMethodAuthority</span><span class="params">($method)</span> </span>&#123;</span><br><span class="line">    $nameSet = explode(<span class="string">'\\'</span>,get_class(<span class="keyword">$this</span>)); <span class="comment">//传入的method中有namespace，获取最后的controller名</span></span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="string">'Controllers'</span>, $nameSet)) &#123;  <span class="comment">//确认是controller中的类</span></span><br><span class="line">        $controlName = end($nameSet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查找数据库获取权限</span></span><br><span class="line">        $resultSet = DB::select(<span class="string">'select `authority` from `authority` where `model` = :model and `method` = :method limit 1'</span>, [<span class="string">'model'</span> =&gt; $controlName, <span class="string">'method'</span> =&gt; $method]);</span><br><span class="line">        <span class="keyword">if</span> (count($resultSet) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//数据库中没有该函数的记录</span></span><br><span class="line">            dd(<span class="string">"no such record in sqlite! please add. model name: "</span> . $controlName . <span class="string">"; method name: "</span> . $method);</span><br><span class="line">        &#125;</span><br><span class="line">        $result = $resultSet[<span class="number">0</span>]-&gt;authority;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//权限判断</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是通用的权限控制，只要数据库中有相应的记录，就可以控制，写的新方法也不需要为了权限控制改代码。</p>
<blockquote>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2></blockquote>
<p>其实，这段代码在我的系统运行时有一个bug的（跑。。。）。</p>
<p>一般系统会把用户的角色写入session中，啥时候写入呢，就是在登录的时候。没错，bug就是这个登录（=。=）。</p>
<p>我是通过获取session中用户角色来获取真正的权限，然后判断是否可以进去，然而登录时session里压根就没有角色，自然会报错。</p>
<p>解决方法有两个。</p>
<ul>
<li>当session中存入角色时，不进行权限判断。</li>
<li>不从session中获取角色，而是查找数据库获取。</li>
</ul>
<p>果断第一种啊。</p>
<p>The End~</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'maywanting';
var disqus_identifier = '2016/03/05/20160305laravel-authority-design/';
var disqus_title = '基于Laravel框架的后台权限设计';
var disqus_url = 'http://maywanting.wang/2016/03/05/20160305laravel-authority-design/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:may@maywanting.wang" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="http://weibo.com/[object Object]" target="_blank"><i class="fa fa-weibo"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2019 <a href="/" rel="nofollow">may</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>